name: Build

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '>=1.21'
      
      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version
      
      - name: Install Go protobuf plugins
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
      
      - name: Compile protobuf files
        run: |
          chmod +x ./script/compile-proto.sh
          ./script/compile-proto.sh
      
      - name: Tidy Go modules
        run: go mod tidy
      
      - name: Build all packages
        run: |
          echo "Building all packages..."
          go build ./...
          echo "✅ All packages built successfully"
      
      - name: Run go vet
        run: |
          echo "Running go vet..."
          go vet ./...
          echo "✅ Go vet passed"
      
      - name: Compile all tests (per-package)
        run: |
          echo "Compiling all tests per package..."
          set -euo pipefail
          failed=0
          while IFS= read -r pkg; do
            dir=$(go list -f '{{.Dir}}' "$pkg")
            if ! (cd "$dir" && go test -c -o "$(basename "$dir").test"); then
              echo "❌ Test compile failed in package $pkg ($dir)"
              failed=1
            fi
          done < <(go list ./...)
          if [ "$failed" -ne 0 ]; then
            echo "❌ One or more test packages failed to compile"
            exit 1
          fi
          echo "✅ Test compilation finished"
      
      - name: Build inspector
        run: |
          echo "Building inspector..."
          go build -o inspector.out ./cmd/inspector
          if [ -f "./inspector.out" ]; then
            echo "✅ Inspector binary built successfully"
          else
            echo "❌ Inspector binary not found"
            exit 1
          fi
      
      - name: Build gate
        run: |
          echo "Building gate..."
          go build -o gate.out ./cmd/gate
          if [ -f "./gate.out" ]; then
            echo "✅ Gate binary built successfully"
          else
            echo "❌ Gate binary not found"
            exit 1
          fi
      
      - name: Build chat server
        run: |
          echo "Building chat server..."
          go build -o server.out ./samples/chat/server
          if [ -f "./server.out" ]; then
            echo "✅ Chat server binary built successfully"
          else
            echo "❌ Chat server binary not found"
            exit 1
          fi
      
      - name: Build chat client
        run: |
          echo "Building chat client..."
          go build -o client.out ./samples/chat/client
          if [ -f "./client.out" ]; then 
            echo "✅ Chat client binary built successfully"
          else
            echo "❌ Chat client binary not found"
            exit 1
          fi
      
      - name: List all build artifacts
        run: |
          echo "Build completed! Generated binaries:"
          ls -la inspector* gateway* server* client* 2>/dev/null || echo "No binaries found matching pattern"

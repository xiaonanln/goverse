# Use official Golang image as the base
FROM golang:1.25-bookworm

# Install system dependencies (including Python, etcd, and PostgreSQL)
RUN apt-get update && apt-get install -y \
    dos2unix \
    protobuf-compiler \
    git \
    python3 \
    python3-pip \
    wget \
    curl \
    ca-certificates \
    postgresql \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Install etcd
RUN wget -q https://github.com/etcd-io/etcd/releases/download/v3.5.10/etcd-v3.5.10-linux-amd64.tar.gz \
    && tar xzf etcd-v3.5.10-linux-amd64.tar.gz \
    && mv etcd-v3.5.10-linux-amd64/etcd* /usr/local/bin/ \
    && rm -rf etcd-v3.5.10-linux-amd64*

# Install Python packages for test_chat.py and stress tests
RUN pip3 install --break-system-packages grpcio grpcio-tools pyyaml

# Install protoc-gen-go and protoc-gen-go-grpc
RUN go install google.golang.org/protobuf/cmd/protoc-gen-go@latest \
    && go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
    
# Make sure /go/bin is on PATH
ENV PATH="/go/bin:${PATH}"

# Set working directory
WORKDIR /app

# Copy the entire project to /app
COPY . .

# Make all .sh files under /app/script executable
RUN find /app/script -type f -name "*.sh" -exec chmod +x {} +

# Download Go dependencies
RUN go mod download

# Compile protocol buffers
RUN ./script/compile-proto.sh

# Configure PostgreSQL
# Create directories for PostgreSQL
RUN mkdir -p /var/run/postgresql && chown -R postgres:postgres /var/run/postgresql

# Initialize PostgreSQL database cluster
RUN su - postgres -c "/usr/lib/postgresql/*/bin/initdb -D /var/lib/postgresql/data"

# Configure PostgreSQL to accept local connections
# Note: This configuration is for development only. In production, restrict to localhost or specific IPs.
RUN echo "host all all 0.0.0.0/0 md5" >> /var/lib/postgresql/data/pg_hba.conf && \
    echo "listen_addresses='*'" >> /var/lib/postgresql/data/postgresql.conf

# Start PostgreSQL, create database and user, then stop
RUN su - postgres -c "/usr/lib/postgresql/*/bin/pg_ctl -D /var/lib/postgresql/data start" && \
    sleep 5 && \
    su - postgres -c "psql -c \"ALTER USER postgres PASSWORD 'postgres';\"" && \
    su - postgres -c "psql -c \"CREATE DATABASE goverse;\"" && \
    su - postgres -c "psql -c \"CREATE USER goverse WITH PASSWORD 'goverse';\"" && \
    su - postgres -c "psql -c \"GRANT ALL PRIVILEGES ON DATABASE goverse TO goverse;\"" && \
    su - postgres -c "psql -d goverse -c \"GRANT ALL ON SCHEMA public TO goverse;\"" && \
    su - postgres -c "/usr/lib/postgresql/*/bin/pg_ctl -D /var/lib/postgresql/data stop"

# Copy and set up entrypoint script
COPY docker/entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Set entrypoint
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]

# Default command (will be passed to entrypoint)
CMD ["bash"]
